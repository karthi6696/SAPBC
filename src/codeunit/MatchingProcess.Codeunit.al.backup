codeunit 85000 "Matching Process"
{
    TableNo = "Job Queue Entry";

    var
        MatchingRules, ParentMatchingRule : Record "Matching Rules";
        GLSetup: Record "General Ledger Setup";
        TempCPMS: Record TTS_ARAP temporary;
        TempSelectedCPMS: Record TTS_ARAP temporary;
        TempSelectedLOB: Record TTS_SAP temporary;
        TempSelectedEOD: Record "EOD Staging" temporary;
        TempEOD: Record "EOD Staging" temporary;
        TempLOB: Record TTS_SAP temporary;

        LOBMatchingRecords, CPMSMatchingRecords, EODMatchingRecords : Dictionary of [Text, Decimal];
        CPMSMatchingKeys: Dictionary of [Text, Text];
        LOBRecordRef, EODRecordRef, CPMSRecordRef : RecordRef;

        SubMatchField, SumSubMatchField, LOBMatchingValue, EODMatchingValue, CPMSMatching : Decimal;
        ParentMatchField, StoreParentKey, RecordKey : Text;
        MatchingOption: Option Matched,Unmatched,Error;

        MatchingId: Code[20];
        // Label placeholders: %1 = Field Name, %2 = Field Name, %3 = Matching Type, %4 = Matching Rule No.
        ErrLbl: Label '%1 does not match the %2 between %3. Applied Rule: %4';
        // Label placeholders: %1 = Matching Rule No.
        SuccessLbl: Label 'Matched by the rule number: %1';

        ForceMatchLbl: Label 'Matched Forcefully';
        MatchMsg: Text;
        MatchType: Enum "Match Type";
        Noseries: Codeunit "No. Series";

        Donotopen: Boolean;

    trigger OnRun()
    begin
        // Initialize GL Setup once
        GLSetup.GetRecordOnce();
        GLSetup.TestField("LOB-CPMS Matching No. Series");
        GLSetup.TestField("LOB-CPMS Error No. Series");
        GLSetup.TestField("EOD-CPMS Matching No. Series");
        GLSetup.TestField("EOD-CPMS Error No. Series");

        case true of
            Rec."Parameter String" = '':
                begin
                    Donotopen := true;
                    MatchLOBCPMSData();
                    MatchEODCPMSData();
                end;
            UpperCase(Rec."Parameter String") = 'CPMS-LOB':
                MatchLOBCPMSData();
            UpperCase(Rec."Parameter String") = 'CPMS-EOD':
                MatchEODCPMSData();
        end;
    end;


    procedure MatchLOBCPMSData()
    var
    begin
        OpenRecordRefsForMatching(LOBRecordRef, CPMSRecordRef, 'CPMS-LOB');

        MatchingRules.Reset();
        MatchingRules.SetCurrentKey("Matching Rule No.");
        MatchingRules.SetRange("Matching Type", MatchingRules."Matching Type"::"CPMS-LOB");
        MatchingRules.SetFilter("Parent Condition No.", '<>%1', 0);

        if MatchingRules.FindSet() then
            repeat
                ProcessLOBCPMSMatchingRule();
            until MatchingRules.Next() = 0;
    end;

    local procedure ProcessLOBCPMSMatchingRule()
    var
        LocalParentRule: Record "Matching Rules";
    begin
        // Clear temp records
        TempLOB.Reset();
        TempLOB.DeleteAll(false);
        TempCPMS.Reset();
        TempCPMS.DeleteAll(false);

        // Load parent conditions if set
        if MatchingRules."Parent Condition No." <> 0 then begin
            LocalParentRule.Reset();
            LocalParentRule.SetRange("Matching Rule No.", MatchingRules."Parent Condition No.");
            if LocalParentRule.FindFirst() then begin
                ParentMatchingRule := LocalParentRule;
                if ParentMatchingRule."LOB Condition" <> '' then
                    InsertLOBTempData(TempLOB, ParentMatchingRule);
                if ParentMatchingRule."CPMS Condition" <> '' then
                    InsertCPMSTempData(TempCPMS, ParentMatchingRule);
            end;
        end;

        // Apply matching rule filters
        if MatchingRules."LOB Condition" <> '' then
            TempLOB.SetView(MatchingRules."LOB Condition");
        if MatchingRules."CPMS Condition" <> '' then
            TempCPMS.SetView(MatchingRules."CPMS Condition");

        // Build matching dictionaries
        ClearMatchingVariables();
        BuildLOBMatchingDictionary();
        ClearMatchingVariables();
        BuildCPMSMatchingDictionary();

        // Perform matching with early exit on found match
        PerformLOBCPMSMatching();
    end;


    procedure MatchEODCPMSData()
    begin
        OpenRecordRefsForMatching(EODRecordRef, CPMSRecordRef, 'CPMS-EOD');

        MatchingRules.Reset();
        MatchingRules.SetCurrentKey("Matching Rule No.");
        MatchingRules.SetRange("Matching Type", MatchingRules."Matching Type"::"CPMS-EOD");
        MatchingRules.SetFilter("Parent Condition No.", '<>%1', 0);

        if MatchingRules.FindSet() then
            repeat
                ProcessEODCPMSMatchingRule();
            until MatchingRules.Next() = 0;
    end;

    local procedure ProcessEODCPMSMatchingRule()
    var
        LocalParentRule: Record "Matching Rules";
    begin
        // Clear temp records
        EODTemp.Reset();
        EODTemp.DeleteAll(false);
        CPMSTemp.Reset();
        CPMSTemp.DeleteAll(false);

        // Load parent conditions if set
        if MatchingRules."Parent Condition No." <> 0 then begin
            LocalParentRule.Reset();
            LocalParentRule.SetRange("Matching Rule No.", MatchingRules."Parent Condition No.");
            if LocalParentRule.FindFirst() then begin
                ParentMatchingRule := LocalParentRule;
                if ParentMatchingRule."EOD Condition" <> '' then
                    InsertEODTempData(EODTemp, ParentMatchingRule);
                if ParentMatchingRule."CPMS Condition" <> '' then
                    InsertCPMSTempData(CPMSTemp, ParentMatchingRule);
            end;
        end;

        // Apply matching rule filters
        if MatchingRules."EOD Condition" <> '' then
            EODTemp.SetView(MatchingRules."EOD Condition");
        if MatchingRules."CPMS Condition" <> '' then
            CPMSTemp.SetView(MatchingRules."CPMS Condition");

        // Build matching dictionaries
        ClearMatchingVariables();
        BuildEODMatchingDictionary();
        ClearMatchingVariables();
        BuildCPMSMatchingDictionary();

        // Perform matching with early exit on found match
        PerformEODCPMSMatching();
    end;


    local procedure OpenRecordRefsForMatching(var pRecordRef1: RecordRef; var pRecordRef2: RecordRef; pMatchingType: Text)
    begin
        case pMatchingType of
            'CPMS-LOB':
                begin
                    pRecordRef1.Open(Database::TTS_SAP);
                    if Donotopen then
                        pRecordRef2.Open(Database::TTS_ARAP);
                end;
            'CPMS-EOD':
                begin
                    pRecordRef1.Open(Database::"EOD Staging");
                    if not Donotopen then
                        pRecordRef2.Open(Database::TTS_ARAP);
                end;
        end;
    end;


    procedure SetMatchType(pMatchtype: Enum "Match Type")
    begin
        MatchType := pMatchtype;
    end;

    procedure SetSelectedLOB(var LOBRecords: Record TTS_SAP temporary)
    begin
        SelectedLOB.Reset();
        SelectedLOB.DeleteAll(false);
        if LOBRecords.FindSet() then
            repeat
                SelectedLOB := LOBRecords;
                SelectedLOB.Insert();
            until LOBRecords.Next() = 0;
    end;

    procedure SetSelectedEOD(var EODRecords: Record "EOD Staging" temporary)
    begin
        SelectedEOD.Reset();
        SelectedEOD.DeleteAll(false);
        if EODRecords.FindSet() then
            repeat
                SelectedEOD := EODRecords;
                SelectedEOD.Insert();
            until EODRecords.Next() = 0;
    end;

    procedure SetSelectedCPMS(var CPMSRecords: Record TTS_ARAP temporary)
    begin
        SelectedCPMS.Reset();
        SelectedCPMS.DeleteAll(false);
        if CPMSRecords.FindSet() then
            repeat
                SelectedCPMS := CPMSRecords;
                SelectedCPMS.Insert();
            until CPMSRecords.Next() = 0;
    end;


    local procedure InsertLOBTempData(var LOBTemp: Record TTS_SAP temporary; var pMatchingRules: Record "Matching Rules")
    var
        LOB: Record TTS_SAP;
    begin
        if MatchType = MatchType::Manual then begin
            SelectedLOB.Reset();
            SelectedLOB.SetView(pMatchingRules."LOB Condition");
            if SelectedLOB.FindSet() then
                repeat
                    LOBTemp.Init();
                    LOBTemp := SelectedLOB;
                    LOBTemp.Insert(false);
                until SelectedLOB.Next() = 0;
        end else begin
            LOB.Reset();
            LOB.SetView(pMatchingRules."LOB Condition");
            if LOB.FindSet() then
                repeat
                    LOBTemp.Init();
                    LOBTemp := LOB;
                    LOBTemp.Insert(false);
                until LOB.Next() = 0;
        end;
    end;

    local procedure InsertEODTempData(var EODTemp: Record "EOD Staging" temporary; var pMatchingRules: Record "Matching Rules")
    var
        EOD: Record "EOD Staging";
    begin
        if MatchType = MatchType::Manual then begin
            SelectedEOD.Reset();
            SelectedEOD.SetView(pMatchingRules."EOD Condition");
            if SelectedEOD.FindSet() then
                repeat
                    EODTemp.Init();
                    EODTemp := SelectedEOD;
                    EODTemp.Insert(false);
                until SelectedEOD.Next() = 0;
        end else begin
            EOD.Reset();
            EOD.SetView(pMatchingRules."EOD Condition");
            if EOD.FindSet() then
                repeat
                    EODTemp.Init();
                    EODTemp := EOD;
                    EODTemp.Insert(false);
                until EOD.Next() = 0;
        end;
    end;

    local procedure InsertCPMSTempData(var CPMSTemp: Record TTS_ARAP temporary; var pMatchingRules: Record "Matching Rules")
    var
        CPMS: Record TTS_ARAP;
    begin
        if MatchType = MatchType::Manual then begin
            SelectedCPMS.Reset();
            SelectedCPMS.SetView(pMatchingRules."CPMS Condition");
            if SelectedCPMS.FindSet() then
                repeat
                    CPMSTemp.Init();
                    CPMSTemp := SelectedCPMS;
                    CPMSTemp.Insert(false);
                until SelectedCPMS.Next() = 0;
        end else begin
            CPMS.Reset();
            CPMS.SetView(pMatchingRules."CPMS Condition");
            if CPMS.FindSet() then
                repeat
                    CPMSTemp.Init();
                    CPMSTemp := CPMS;
                    CPMSTemp.Insert(false);
                until CPMS.Next() = 0;
        end;
    end;

    local procedure ClearMatchingVariables()
    begin
        Clear(ParentMatchField);
        Clear(StoreParentKey);
        LastParentFieldValue := '';
    end;


    local procedure BuildLOBMatchingDictionary()
    var
        LOBField: FieldRef;
        ParentFieldRef: FieldRef;
        ChildFieldRef: FieldRef;
        SumValue: Decimal;
        CurrentParentValue: Text;
    begin
        Clear(LOBMatchingRecords);
        LOBRecordRef.GetTable(LOBTemp);

        if not LOBRecordRef.FindSet() then
            exit;

        // Get field references
        ParentFieldRef := LOBRecordRef.Field(ParentMatchingRule."LOB Field No.");
        ChildFieldRef := LOBRecordRef.Field(MatchingRules."LOB Field No.");

        repeat
            CurrentParentValue := Format(ParentFieldRef.Value);

            // Only process if this is a new parent value
            if CurrentParentValue <> LastParentFieldValue then begin
                Clear(SumValue);

                // Sum all child values for this parent value
                LOBRecordRef.Field(ParentMatchingRule."LOB Field No.").SetFilter(CurrentParentValue);
                LOBRecordRef.FindSet();
                repeat
                    SumValue += ChildFieldRef.Value;
                until LOBRecordRef.Next() = 0;

                LOBMatchingRecords.Add(CurrentParentValue, SumValue);
                LastParentFieldValue := CurrentParentValue;
                LOBRecordRef.FindSet();
            end;
        until LOBRecordRef.Next() = 0;
    end;

    local procedure BuildEODMatchingDictionary()
    var
        ParentFieldRef: FieldRef;
        ChildFieldRef: FieldRef;
        SumValue: Decimal;
        CurrentParentValue: Text;
    begin
        Clear(EODMatchingRecords);
        EODRecordRef.GetTable(EODTemp);

        if not EODRecordRef.FindSet() then
            exit;

        // Get field references
        ParentFieldRef := EODRecordRef.Field(ParentMatchingRule."EOD Field No.");
        ChildFieldRef := EODRecordRef.Field(MatchingRules."EOD Field No.");

        repeat
            CurrentParentValue := Format(ParentFieldRef.Value);

            // Only process if this is a new parent value
            if CurrentParentValue <> LastParentFieldValue then begin
                Clear(SumValue);

                // Sum all child values for this parent value
                EODRecordRef.Field(ParentMatchingRule."EOD Field No.").SetFilter(CurrentParentValue);
                EODRecordRef.FindSet();
                repeat
                    SumValue += Abs(ChildFieldRef.Value);
                until EODRecordRef.Next() = 0;

                EODMatchingRecords.Add(CurrentParentValue, SumValue);
                LastParentFieldValue := CurrentParentValue;
                EODRecordRef.FindSet();
            end;
        until EODRecordRef.Next() = 0;
    end;

    local procedure BuildCPMSMatchingDictionary()
    var
        ParentFieldRef: FieldRef;
        ChildFieldRef: FieldRef;
        SumValue: Decimal;
        CurrentParentValue: Text;
        FormattedKey: Text;
    begin
        Clear(CPMSMatchingRecords);
        Clear(CPMSMatchingKeys);
        CPMSRecordRef.GetTable(CPMSTemp);

        if not CPMSRecordRef.FindSet() then
            exit;

        // Get field references
        ParentFieldRef := CPMSRecordRef.Field(ParentMatchingRule."CPMS Field No.");
        ChildFieldRef := CPMSRecordRef.Field(MatchingRules."CPMS Field No.");

        repeat
            CurrentParentValue := Format(ParentFieldRef.Value);

            // Only process if this is a new parent value
            if CurrentParentValue <> LastParentFieldValue then begin
                Clear(SumValue);

                // Sum all child values for this parent value
                CPMSRecordRef.Field(ParentMatchingRule."CPMS Field No.").SetFilter(CurrentParentValue);
                CPMSRecordRef.FindSet();
                repeat
                    SumValue += ChildFieldRef.Value;
                until CPMSRecordRef.Next() = 0;

                // Handle special case for CPMS-LOB matching with field 17 (invoice number)
                if (ParentMatchingRule."Matching Type" = ParentMatchingRule."Matching Type"::"CPMS-LOB") and
                   (ParentMatchingRule."CPMS Field No." = 17) then begin
                    FormattedKey := CurrentParentValue.Replace('-', '');
                    CPMSMatchingKeys.Add(FormattedKey, CurrentParentValue);
                    CPMSMatchingRecords.Add(FormattedKey, SumValue);
                end else
                    CPMSMatchingRecords.Add(CurrentParentValue, SumValue);

                LastParentFieldValue := CurrentParentValue;
                CPMSRecordRef.FindSet();
            end;
        until CPMSRecordRef.Next() = 0;
    end;

    local procedure PerformLOBCPMSMatching()
    var
        KeyValue: Text;
        EntryNo: Text;
        LOBValue: Decimal;
        CPMSValue: Decimal;
        MatchFound: Boolean;
    begin
        foreach KeyValue in LOBMatchingRecords.Keys do begin
            if LOBMatchingRecords.Get(KeyValue, LOBValue) and CPMSMatchingRecords.Get(KeyValue, CPMSValue) then begin
                if LOBValue = CPMSValue then begin
                    MatchingOption := MatchingOption::Matched;
                    MatchingId := Noseries.GetNextNo(GLSetup."LOB-CPMS Matching No. Series");
                    MatchMsg := StrSubstNo(SuccessLbl, MatchingRules."Matching Rule No.");
                    MatchFound := true;
                end else begin
                    MatchingOption := MatchingOption::Error;
                    MatchingId := Noseries.GetNextNo(GLSetup."LOB-CPMS Error No. Series");
                    MatchMsg := StrSubstNo(ErrLbl, MatchingRules."LOB Field Name", MatchingRules."CPMS Field Name",
                                          MatchingRules."Matching Type", MatchingRules."Matching Rule No.");
                end;

                UpdateLOBMatchedRecords(KeyValue);
                UpdateCPMSLOBMatchedRecords(KeyValue);

                // Exit on first matched record for better performance
                if MatchFound then
                    exit;
            end;
        end;
    end;

    local procedure PerformEODCPMSMatching()
    var
        KeyValue: Text;
        EODValue: Decimal;
        CPMSValue: Decimal;
        MatchFound: Boolean;
    begin
        foreach KeyValue in EODMatchingRecords.Keys do begin
            if EODMatchingRecords.Get(KeyValue, EODValue) and CPMSMatchingRecords.Get(KeyValue, CPMSValue) then begin
                if EODValue = CPMSValue then begin
                    MatchingOption := MatchingOption::Matched;
                    MatchingId := Noseries.GetNextNo(GLSetup."EOD-CPMS Matching No. Series");
                    MatchMsg := StrSubstNo(SuccessLbl, MatchingRules."Matching Rule No.");
                    MatchFound := true;
                end else begin
                    MatchingOption := MatchingOption::Error;
                    MatchingId := Noseries.GetNextNo(GLSetup."EOD-CPMS Error No. Series");
                    MatchMsg := StrSubstNo(ErrLbl, MatchingRules."EOD Field Name", MatchingRules."CPMS Field Name",
                                          MatchingRules."Matching Type", MatchingRules."Matching Rule No.");
                end;

                UpdateEODMatchedRecords(KeyValue);
                UpdateCPMSEODMatchedRecords(KeyValue);

                // Exit on first matched record for better performance
                if MatchFound then
                    exit;
            end;
        end;
    end;

    local procedure UpdateLOBMatchedRecords(pKeyValue: Text)
    var
        UpdateRecordRef: RecordRef;
    begin
        UpdateRecordRef.Open(Database::TTS_SAP);
        UpdateRecordRef.SetView(LOBTemp.GetView());
        UpdateRecordRef.Field(ParentMatchingRule."LOB Field No.").SetFilter(pKeyValue);

        if UpdateRecordRef.FindSet() then
            repeat
                UpdateRecordRef.Field(85005).Value := MatchingOption;
                UpdateRecordRef.Field(85006).Value := MatchingId;
                UpdateRecordRef.Field(85007).Value := CurrentDateTime;
                UpdateRecordRef.Field(85008).Value := MatchingRules."Matching Rule No.";
                UpdateRecordRef.Field(85009).Value := MatchMsg;
                UpdateRecordRef.Field(41).Value := UserId;
                UpdateRecordRef.Field(42).Value := MatchType;
                UpdateRecordRef.Modify(false);
            until UpdateRecordRef.Next() = 0;
    end;

    local procedure UpdateEODMatchedRecords(pKeyValue: Text)
    var
        UpdateRecordRef: RecordRef;
    begin
        UpdateRecordRef.Open(Database::"EOD Staging");
        UpdateRecordRef.SetView(EODTemp.GetView());
        UpdateRecordRef.Field(ParentMatchingRule."EOD Field No.").SetFilter(pKeyValue);

        if UpdateRecordRef.FindSet() then
            repeat
                UpdateRecordRef.Field(31).Value := MatchingOption;
                UpdateRecordRef.Field(32).Value := MatchingId;
                UpdateRecordRef.Field(33).Value := CurrentDateTime;
                UpdateRecordRef.Field(34).Value := MatchingRules."Matching Rule No.";
                UpdateRecordRef.Field(35).Value := MatchMsg;
                UpdateRecordRef.Field(36).Value := UserId;
                UpdateRecordRef.Field(37).Value := MatchType;
                UpdateRecordRef.Modify(false);
            until UpdateRecordRef.Next() = 0;
    end;

    local procedure UpdateCPMSLOBMatchedRecords(pKeyValue: Text)
    var
        UpdateRecordRef: RecordRef;
        LookupValue: Text;
    begin
        UpdateRecordRef.Open(Database::TTS_ARAP);
        UpdateRecordRef.SetView(CPMSTemp.GetView());

        // Handle special case for CPMS field 17 (invoice number with dashes)
        if ParentMatchingRule."CPMS Field No." = 17 and CPMSMatchingKeys.Get(pKeyValue, LookupValue) then
            UpdateRecordRef.Field(ParentMatchingRule."CPMS Field No.").SetFilter(LookupValue)
        else
            UpdateRecordRef.Field(ParentMatchingRule."CPMS Field No.").SetFilter(pKeyValue);

        if UpdateRecordRef.FindSet() then
            repeat
                UpdateRecordRef.Field(85009).Value := MatchingOption;
                UpdateRecordRef.Field(85010).Value := MatchingId;
                UpdateRecordRef.Field(85013).Value := CurrentDateTime;
                UpdateRecordRef.Field(85015).Value := MatchingRules."Matching Rule No.";
                UpdateRecordRef.Field(85018).Value := MatchMsg;
                UpdateRecordRef.Field(51).Value := UserId;
                UpdateRecordRef.Field(53).Value := MatchType;
                UpdateRecordRef.Modify(false);
            until UpdateRecordRef.Next() = 0;
    end;

    local procedure UpdateCPMSEODMatchedRecords(pKeyValue: Text)
    var
        UpdateRecordRef: RecordRef;
    begin
        UpdateRecordRef.Open(Database::TTS_ARAP);
        UpdateRecordRef.SetView(CPMSTemp.GetView());
        UpdateRecordRef.Field(ParentMatchingRule."CPMS Field No.").SetFilter(pKeyValue);

        if UpdateRecordRef.FindSet() then
            repeat
                UpdateRecordRef.Field(85011).Value := MatchingOption;
                UpdateRecordRef.Field(85012).Value := MatchingId;
                UpdateRecordRef.Field(85014).Value := CurrentDateTime;
                UpdateRecordRef.Field(85016).Value := MatchingRules."Matching Rule No.";
                UpdateRecordRef.Field(85017).Value := MatchMsg;
                UpdateRecordRef.Field(50).Value := UserId;
                UpdateRecordRef.Field(52).Value := MatchType;
                UpdateRecordRef.Modify(false);
            until UpdateRecordRef.Next() = 0;
    end;

    procedure ForceLOBCPMSMatch(var pLOBTemp: Record TTS_SAP; var pCPMSTemp: Record TTS_ARAP)
    var
        LOBRecords: Record TTS_SAP;
        CPMSRecords: Record TTS_ARAP;
        MatchID: Code[20];
    begin
        GLSetup.GetRecordOnce();
        GLSetup.TestField("LOB-CPMS Matching No. Series");
        MatchID := Noseries.GetNextNo(GLSetup."LOB-CPMS Matching No. Series");

        // Batch update LOB records
        if pLOBTemp.FindSet() then
            repeat
                LOBRecords.Get(pLOBTemp."Entry No.");
                LOBRecords."Matching Status" := LOBRecords."Matching Status"::Matched;
                LOBRecords."Matching ID" := MatchID;
                LOBRecords."Match Type" := LOBRecords."Match Type"::Force;
                LOBRecords."Matching Processed Date Time" := CurrentDateTime;
                LOBRecords."Matched By" := UserId;
                LOBRecords."Match Details" := ForceMatchLbl;
                LOBRecords.Modify(false);
            until pLOBTemp.Next() = 0;

        // Batch update CPMS records
        if pCPMSTemp.FindSet() then
            repeat
                CPMSRecords.Get(pCPMSTemp."Entry No.");
                CPMSRecords."LOB Matching Status" := CPMSRecords."LOB Matching Status"::Matched;
                CPMSRecords."LOB Matching ID" := MatchID;
                CPMSRecords."LOB Match Type" := CPMSRecords."LOB Match Type"::Force;
                CPMSRecords."LOB Processed Date Time" := CurrentDateTime;
                CPMSRecords."LOB Match Details" := ForceMatchLbl;
                CPMSRecords."LOB Matched By" := UserId;
                CPMSRecords.Modify(false);
            until pCPMSTemp.Next() = 0;
    end;


    procedure ForceEODCPMSMatch(var pEODTemp: Record "EOD Staging"; var pCPMSTemp: Record TTS_ARAP)
    var
        EODRecords: Record "EOD Staging";
        CPMSRecords: Record TTS_ARAP;
        MatchID: Code[20];
    begin
        GLSetup.GetRecordOnce();
        GLSetup.TestField("EOD-CPMS Matching No. Series");
        MatchID := Noseries.GetNextNo(GLSetup."EOD-CPMS Matching No. Series");

        // Batch update EOD records
        if pEODTemp.FindSet() then
            repeat
                EODRecords.Get(pEODTemp."Entry No.");
                EODRecords."Matching Status" := EODRecords."Matching Status"::Matched;
                EODRecords."Matching ID" := MatchID;
                EODRecords."Match Type" := EODRecords."Match Type"::Force;
                EODRecords."Matching Processed Date Time" := CurrentDateTime;
                EODRecords."Match Details" := ForceMatchLbl;
                EODRecords."Matched By" := UserId;
                EODRecords.Modify(false);
            until pEODTemp.Next() = 0;

        // Batch update CPMS records
        if pCPMSTemp.FindSet() then
            repeat
                CPMSRecords.Get(pCPMSTemp."Entry No.");
                CPMSRecords."EOD Matching Status" := CPMSRecords."EOD Matching Status"::Matched;
                CPMSRecords."EOD Matching ID" := MatchID;
                CPMSRecords."EOD Match Type" := CPMSRecords."EOD Match Type"::Force;
                CPMSRecords."EOD Processed Date Time" := CurrentDateTime;
                CPMSRecords."EOD Match Details" := ForceMatchLbl;
                CPMSRecords."EOD Matched By" := UserId;
                CPMSRecords.Modify(false);
            until pCPMSTemp.Next() = 0;
    end;

}